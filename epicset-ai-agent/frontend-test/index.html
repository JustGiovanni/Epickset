<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EpicSet ‚Ä¢ AI Generator (Test)</title>
  <style>
    :root{
      --bg0:#070412; --bg1:#0b0617;
      --muted: rgba(255,255,255,.72);
      --purple:#7c4dff; --purple2:#a855f7;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
    html, body{ height:100%; }
    body{
      margin:0; color:#fff;
      background:
        radial-gradient(1200px 700px at 18% 0%, rgba(124,77,255,.35) 0%, rgba(10,6,24,1) 55%, rgba(7,4,18,1) 100%),
        radial-gradient(900px 500px at 90% 20%, rgba(168,85,247,.18) 0%, rgba(7,4,18,0) 65%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
    }
    .app{ display:flex; height:100vh; overflow:hidden; }
    .sidebar{
      width:280px; padding:20px 18px;
      border-right:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(124,77,255,.18) 0%, rgba(0,0,0,0) 55%);
    }
    .brand{ display:flex; gap:12px; align-items:center; margin-bottom:18px; }
    .logo{ width:40px; height:40px; border-radius:14px; background:linear-gradient(135deg,var(--purple),var(--purple2)); box-shadow:0 18px 55px rgba(124,77,255,.38); }
    .brandName{ font-weight:900; }
    .brandSub{ font-size:12px; opacity:.7; margin-top:2px; }
    .nav{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .navItem{
      color:var(--muted); text-decoration:none;
      padding:10px 12px; border-radius:14px; border:1px solid transparent;
      transition:.15s ease; display:flex; align-items:center; gap:10px;
    }
    .navItem:hover{ color:#fff; background:rgba(255,255,255,.04); border-color:rgba(255,255,255,.06); }
    .navItem.active{ color:#fff; background:rgba(124,77,255,.18); border-color:rgba(124,77,255,.35); }
    .navDivider{ height:1px; background:rgba(255,255,255,.08); margin:6px 0; }
    .sidebarFooter{ margin-top:auto; display:flex; align-items:center; gap:10px; padding-top:18px; border-top:1px solid rgba(255,255,255,.08); }
    .avatar{ width:36px; height:36px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); }

    .main{ flex:1; display:flex; flex-direction:column; min-width:0; }
    .topbar{
      height:64px; display:flex; align-items:center; gap:14px; padding:0 22px;
      border-bottom:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.14); backdrop-filter: blur(10px);
    }
    .topTitle{ font-weight:900; }
    .topSearch{
      flex:1; max-width:560px; display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
    }
    .topSearch input{ width:100%; background:transparent; border:none; outline:none; color:#fff; }
    .syncPill{
      display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      background:rgba(0,255,160,.10); border:1px solid rgba(0,255,160,.22);
      color:rgba(190,255,230,.95); font-size:12px; font-weight:900;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background:rgba(0,255,160,.9); }

    .canvas{ position:relative; flex:1; padding:26px 22px 92px; overflow:auto; }
    .panel{
      max-width:920px; margin:0 auto; padding:26px; border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.09);
      box-shadow:0 28px 90px rgba(0,0,0,.42);
    }
    .hidden{ display:none; }
    .sparkle{
      width:58px; height:58px; margin:0 auto 14px; display:grid; place-items:center; border-radius:999px;
      background:rgba(124,77,255,.20); border:1px solid rgba(124,77,255,.35); box-shadow:0 16px 55px rgba(124,77,255,.20);
    }
    h1{ margin:0 0 18px; text-align:center; font-size:32px; }
    .muted{ color:var(--muted); }

    .promptBox{ background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.09); border-radius:20px; padding:18px; }
    .promptBoxTitle{ font-weight:900; font-size:13px; margin-bottom:12px; }
    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px; }
    .chip{
      padding:9px 12px; border-radius:999px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
      color:rgba(255,255,255,.86); font-size:12px; cursor:pointer;
    }
    textarea{
      width:100%; min-height:100px; resize:none; border-radius:18px; padding:14px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); color:#fff; outline:none;
    }
    textarea::placeholder{ color:rgba(255,255,255,.45); }
    .promptMeta{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:12px; }
    .metaLabel{ font-size:12px; color:rgba(255,255,255,.55); }
    .metaRow{ display:flex; align-items:center; gap:8px; margin-top:6px; }
    .metaRow input{
      width:100px; padding:10px 12px; border-radius:16px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10); color:#fff; outline:none;
    }
    .btnPrimary{
      border:none; cursor:pointer; border-radius:16px; padding:12px 16px; font-weight:900; color:#fff;
      background:linear-gradient(90deg, var(--purple), var(--purple2)); box-shadow:0 18px 55px rgba(124,77,255,.22);
    }
    .btnGhost{
      border:1px solid rgba(255,255,255,.14); cursor:pointer; border-radius:16px; padding:12px 16px; font-weight:900; color:#fff;
      background:rgba(255,255,255,.06);
    }

    .trackList{ margin-top:14px; display:flex; flex-direction:column; gap:10px; }
    .track{
      display:flex; justify-content:space-between; align-items:center; gap:14px;
      padding:12px 14px; border-radius:16px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
    }
    .trackLeft{ display:flex; gap:12px; align-items:center; }
    .trackNum{
      width:28px; height:28px; border-radius:9px; display:grid; place-items:center; font-weight:950; font-size:12px;
      background:rgba(124,77,255,.22); border:1px solid rgba(124,77,255,.35);
    }
    .trackTitle{ font-weight:950; font-size:13px; }
    .trackSub{ font-size:12px; color:rgba(255,255,255,.70); margin-top:2px; }
    .stats{ display:flex; gap:10px; }
    .statPill{
      display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); font-weight:950; font-size:13px;
    }

    .bottomBar{
      position:fixed; left:280px; right:0; bottom:0; height:66px; padding:10px 22px; display:flex; gap:10px; align-items:center;
      background:rgba(8,4,18,.84); border-top:1px solid rgba(255,255,255,.08); backdrop-filter: blur(10px);
    }
    .bottomBar input{
      flex:1; height:44px; padding:0 14px; border-radius:999px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12); color:#fff; outline:none;
    }
    .sendBtn{ width:44px; height:44px; border-radius:999px; border:none; cursor:pointer; background:linear-gradient(90deg,var(--purple),var(--purple2)); color:#fff; font-weight:950; }
    .toast{
      position:fixed; right:18px; bottom:88px; max-width:460px; padding:12px 14px; border-radius:16px;
      background:rgba(255,70,70,.14); border:1px solid rgba(255,70,70,.28); color:rgba(255,220,220,.95); font-weight:800;
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="brandName">EpicSet</div>
          <div class="brandSub">Beta</div>
        </div>
      </div>

      <nav class="nav">
        <a class="navItem" href="#">Dashboard</a>
        <a class="navItem active" href="#">AI Generator</a>
        <a class="navItem" href="#">Setlists</a>
        <a class="navItem" href="#">Library</a>
        <div class="navDivider"></div>
        <a class="navItem" href="#">Collaborators</a>
        <a class="navItem" href="#">Bands</a>
      </nav>

      <div class="sidebarFooter">
        <div class="avatar"></div>
        <div>
          <div style="font-weight:800; font-size:13px;">EpicSet</div>
          <div style="opacity:.65; font-size:12px;">Free Plan</div>
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topTitle">AI Generator</div>
        <div class="topSearch">
          <div style="opacity:.6">‚åï</div>
          <input placeholder="Search songs, artists, albums, or tags..." />
        </div>
        <div class="syncPill"><span class="dot"></span> Synced</div>
      </header>

      <section class="canvas">
        <div id="landing" class="panel">
          <div class="sparkle">‚ú¶</div>
          <h1>What kind of setlist should I create?</h1>

          <div class="promptBox">
            <div class="promptBoxTitle">Need inspiration? <span class="muted">Try these:</span></div>
            <div class="chips" id="chips"></div>

            <textarea id="prompt" maxlength="500" placeholder="e.g., Afrobeats party setlist for 45 mins, include Tems..."></textarea>

            <div class="promptMeta">
              <div>
                <div class="metaLabel">Target duration</div>
                <div class="metaRow">
                  <input id="mins" type="number" value="45" min="5" max="240" />
                  <span class="metaLabel">mins</span>
                </div>
              </div>

              <button id="go" class="btnPrimary">‚ú¶ Generate Now</button>
            </div>
          </div>
        </div>

        <div id="result" class="panel hidden">
          <div style="display:flex; justify-content:space-between; gap:14px; align-items:flex-start;">
            <div>
              <div id="headline" style="font-weight:950; font-size:16px;"></div>
              <div id="explain" style="margin-top:6px; color:rgba(255,255,255,.86); line-height:1.45;"></div>
              <div id="hint" class="muted" style="margin-top:10px; font-size:12px;"></div>
            </div>

            <div class="stats">
              <div class="statPill">‚ô´ <span id="songs">0</span> Songs</div>
              <div class="statPill">‚è± <span id="dur">0</span> mins</div>
            </div>
          </div>

          <div id="list" class="trackList"></div>

          <div style="margin-top:14px; display:flex; justify-content:center; gap:10px;">
            <button id="regen" class="btnGhost">‚ü≥ Regenerate</button>
            <button id="save" class="btnPrimary">üíæ Save (Mock)</button>
          </div>
        </div>

        <div class="bottomBar">
          <input id="bottom" placeholder="Ask me something..." />
          <button id="send" class="sendBtn">‚Üë</button>
        </div>

        <div id="toast" class="toast hidden"></div>
      </section>
    </main>
  </div>

  <script>
    const API = "http://localhost:4000/api/setlist/generate";

    const SUGGESTED = [
      "Afrobeats party setlist for 45 mins, include Tems",
      "Worship setlist for a church service, uplifting and singable",
      "Chill acoustic coffee shop vibe setlist",
      "High-energy festival opener setlist",
      "Wedding reception setlist (romantic ‚Üí party)"
    ];

    const chips = document.getElementById("chips");
    const promptEl = document.getElementById("prompt");
    const minsEl = document.getElementById("mins");
    const go = document.getElementById("go");

    const landing = document.getElementById("landing");
    const result = document.getElementById("result");

    const headline = document.getElementById("headline");
    const explain = document.getElementById("explain");
    const hint = document.getElementById("hint");
    const list = document.getElementById("list");
    const songs = document.getElementById("songs");
    const dur = document.getElementById("dur");

    const bottom = document.getElementById("bottom");
    const send = document.getElementById("send");

    const regenBtn = document.getElementById("regen");
    const saveBtn = document.getElementById("save");

    const toast = document.getElementById("toast");

    // Agent state returned from server; send it back each turn
    let agentState = {
      pendingPrompt: null,
      clarificationAsked: false,
      refinementUsed: false,
      lastSetlist: null,
      originalPrompt: null
    };

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.remove("hidden");
      setTimeout(()=>toast.classList.add("hidden"), 2600);
    }

    function show(el){
      landing.classList.add("hidden");
      result.classList.add("hidden");
      el.classList.remove("hidden");
    }

    // Total minutes for the header stat (never show 0 if tracks exist)
    function totalMinutesFromSeconds(sec){
      const m = Math.round((sec || 0) / 60);
      return Math.max(1, m);
    }

    // Per-track duration as M:SS (prevents "0 mins" problem)
    function formatDuration(sec){
      const s = Number(sec);
      if (!Number.isFinite(s) || s <= 0) return "‚Äî";
      const mm = Math.floor(s / 60);
      const ss = Math.floor(s % 60);
      return `${mm}:${String(ss).padStart(2, "0")}`;
    }

    function renderClarify(question){
      headline.textContent = "Quick question";
      explain.textContent = question;
      hint.textContent = "Reply below with your answer (only one question in MVP).";
      list.innerHTML = "";
      songs.textContent = "0";
      dur.textContent = "0";
      show(result);
    }

    function renderSetlist(setlist, followUp){
      headline.textContent = "Your setlist is ready";
      explain.textContent = (setlist.explanation || "");
      hint.textContent = followUp ? followUp + " (You can send ONE refinement in MVP.)" : "";
      list.innerHTML = "";

      const tracks = setlist.tracks || [];
      songs.textContent = String(tracks.length);

      const totalSec = tracks.reduce((acc,t)=>acc + (Number(t.duration) || 0), 0);
      dur.textContent = tracks.length ? String(totalMinutesFromSeconds(totalSec)) : "0";

      tracks.forEach((t)=>{
        const row = document.createElement("div");
        row.className = "track";

        const d = Number(t.duration) || 0;

        row.innerHTML = `
          <div class="trackLeft">
            <div class="trackNum">${t.position}</div>
            <div>
              <div class="trackTitle">${t.title}</div>
              <div class="trackSub">${t.artist} ‚Ä¢ ${formatDuration(d)}</div>
            </div>
          </div>
          <div style="opacity:.62; font-size:12px; min-width:120px; text-align:right;">
            ${formatDuration(d)}
          </div>
        `;
        list.appendChild(row);
      });

      show(result);
    }

    async function callAgent({ prompt, refinement=null, previousSetlist=null, regenerate=false }){
      const body = {
        prompt,
        targetDurationMinutes: Number(minsEl.value) || null,
        refinement,
        previousSetlist,
        regenerate,
        state: agentState
      };

      const res = await fetch(API, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });

      const json = await res.json();
      if(!res.ok) throw new Error(json?.message || json?.error || "Request failed");
      return json;
    }

    async function runGenerate(userPrompt){
      const out = await callAgent({ prompt: userPrompt });
      agentState = out.state || agentState;

      if(out.type === "clarify"){
        renderClarify(out.question);
        return;
      }

      if(out.type === "setlist"){
        renderSetlist(out.setlist, out.followUp);
        return;
      }

      showToast("Unexpected response type.");
    }

    async function runBottomInput(text){
      // If we are waiting for clarification answer, send it as prompt (agent knows)
      if (agentState.clarificationAsked && agentState.pendingPrompt) {
        const out = await callAgent({ prompt: text });
        agentState = out.state || agentState;

        if(out.type === "setlist") renderSetlist(out.setlist, out.followUp);
        else if(out.type === "clarify") renderClarify(out.question);
        return;
      }

      // If we already have a setlist and refinement not used, treat bottom input as refinement
      if (agentState.lastSetlist && !agentState.refinementUsed) {
        const basePrompt = agentState.originalPrompt || promptEl.value.trim() || "setlist request";

        const out = await callAgent({
          prompt: basePrompt,
          refinement: text,
          previousSetlist: agentState.lastSetlist
        });

        agentState = out.state || agentState;

        if(out.type === "setlist") renderSetlist(out.setlist, out.followUp);
        return;
      }

      // Otherwise: treat as new request
      await runGenerate(text);
    }

    async function runRegenerate(){
      if (!agentState.lastSetlist) return showToast("Generate a setlist first.");
      const basePrompt = agentState.originalPrompt || promptEl.value.trim();
      if (!basePrompt || basePrompt.length < 5) return showToast("Missing original prompt.");

      const out = await callAgent({
        prompt: basePrompt,
        regenerate: true
      });

      agentState = out.state || agentState;
      if(out.type === "setlist") renderSetlist(out.setlist, out.followUp);
    }

    function renderChips(){
      chips.innerHTML = "";
      SUGGESTED.forEach(t=>{
        const b = document.createElement("button");
        b.className = "chip";
        b.type = "button";
        b.textContent = t;
        b.onclick = ()=>{ promptEl.value = t; promptEl.focus(); };
        chips.appendChild(b);
      });
    }

    go.onclick = async ()=>{
      const p = (promptEl.value || "").trim();
      if(p.length < 5) return showToast("Enter at least 5 characters.");
      try { await runGenerate(p); } catch(e){ showToast(e.message); }
    };

    send.onclick = async ()=>{
      const p = (bottom.value || "").trim();
      if(!p) return;
      bottom.value = "";
      try { await runBottomInput(p); } catch(e){ showToast(e.message); }
    };

    bottom.addEventListener("keydown",(e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        send.click();
      }
    });

    regenBtn.onclick = async ()=>{
      try { await runRegenerate(); } catch(e){ showToast(e.message); }
    };

    saveBtn.onclick = ()=> alert("Mock Save. Next step: integrate with backend save endpoint.");

    renderChips();
    show(landing);
  </script>
</body>
</html>
